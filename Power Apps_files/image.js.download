/*! For license information please see Image.js.LICENSE.txt */
(function(){return this?this:window}())["@pa-client/image"]=function(e){var t={};function i(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(o,r,function(t){return e[t]}.bind(null,r));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t,i){"use strict";i.r(t),i.d(t,"TransformMatrix",(function(){return r})),i.d(t,"Image",(function(){return n}));var o;!function(e){e.Hidden="hidden",e.Visible=""}(o||(o={}));var r=function(){function e(e,t,i,o){this._a=e,this._b=t,this._c=i,this._d=o}return Object.defineProperty(e.prototype,"a",{get:function(){return this._a},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this._b},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"c",{get:function(){return this._c},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"d",{get:function(){return this._d},enumerable:!1,configurable:!0}),e.prototype.multiply=function(t){return new e(this.a*t.a+this.c*t.b,this.b*t.a+this.d*t.b,this.a*t.c+this.c*t.d,this.b*t.c+this.d*t.d)},e.prototype.equals=function(e){return this.a===e.a&&this.b===e.b&&this.c===e.c&&this.d===e.d},e.prototype.toCssString=function(){return"matrix(".concat(this.a,", ").concat(this.b,", ").concat(this.c,", ").concat(this.d,", 0, 0)")},e.prototype.hasHorizontalRotation=function(){return 0!==this.b&&0!==this.c},e.Rotate90=new e(0,1,-1,0),e.Rotate180=new e(-1,0,0,-1),e.Rotate270=new e(0,-1,1,0),e.FlipHorizontal=new e(-1,0,0,1),e.FlipVertical=new e(1,0,0,-1),e.Identity=new e(1,0,0,1),e}(),n=function(){function e(){var e=this;this._debouncedDimensionsUpdate=new Core.DebouncedMethod((function(t,i,o){return e.updateDimensions(t,i,o)}),1)}return e.prototype.initControlContext=function(e){e.imageSrc=ko.observable(""),e.imageUrl=ko.observable(""),e.transform=ko.observable(""),e.hasHorizontalRotation=ko.observable(!1),e.backgroundSize=ko.observable("auto"),e.innerHeight=ko.observable("100%"),e.innerWidth=ko.observable("100%"),e.innerVisibility=ko.observable(o.Visible),e.imageAvailable=ko.observable(!1),e.imageStub=null,e._currentMediaRef=null,e._lastImagePromise=null,e._lastImagePromiseAbortController=null},e.prototype.disposeControlContext=function(e){e._currentMediaRef&&(e._currentMediaRef.dispose(),e._currentMediaRef=null),e.imageStub=null,delete e.imageSrc,delete e.imageUrl,delete e.hasHorizontalRotation,delete e.transform,delete e.innerHeight,delete e.innerWidth,delete e.backgroundSize,delete e.innerVisibility},e.prototype.initView=function(e,t){t.properties.ImagePosition&&t.backgroundSize(t.properties.ImagePosition().size),t.onImageStubLoadHandler=this._onImageStubLoad.bind(this,t),t.onClickHandler=this._onClick.bind(null,t),t.onImageLoad=this._onImageLoad.bind(null,t),t.onImageError=this._onImageError.bind(null,t),t.imageAvailable(!1),t.modelProperties.Image&&this.onChangeImage({oldValue:null,newValue:t.modelProperties.Image.getValue()},t);var i=e.querySelector(".appmagic-image-button");t._accessibilityItem=AppMagic.Controls.AccessibilityHelper.createAccessibilityItem(t,i),AppMagic.Controls.AccessibilityManager.registerItem(t._accessibilityItem),t.viewState.isAutoDisabled(!1),ko.applyBindings(t,e)},e.prototype.disposeView=function(e,t){this._clearImageStubs(t),t.onImageStubLoadHandler&&(t.onImageStubLoadHandler=null),t.onClickHandler&&(t.onClickHandler=null),t._lastImagePromise&&(Core.PromiseUtils.abortPromise(t._lastImagePromise,t._lastImagePromiseAbortController),t._lastImagePromise=null,t._lastImagePromiseAbortController=null),t._accessibilityItem&&(AppMagic.Controls.AccessibilityManager.unregisterItem(t._accessibilityItem),t._accessibilityItem.dispose(),t._accessibilityItem=null)},e.prototype.onChangeTabIndex=function(e,t){t.realized&&t._accessibilityItem&&AppMagic.Controls.AccessibilityHelper.updateTabIndex(t._accessibilityItem,t)},e.prototype.onChangeZIndex=function(e,t){t.realized&&t._accessibilityItem&&AppMagic.Controls.AccessibilityHelper.updateZIndex(t._accessibilityItem,t)},e.prototype.onChangeWidth=function(e,t){t.realized&&this._updateSizeAndTransform(t)},e.prototype.onChangeHeight=function(e,t){t.realized&&this._updateSizeAndTransform(t)},e.prototype.onChangeX=function(e,t){t.realized&&this._onChangeLocation(t)},e.prototype.onChangeY=function(e,t){t.realized&&this._onChangeLocation(t)},e.prototype._onChangeLocation=function(e){e.realized&&e._accessibilityItem&&AppMagic.Controls.AccessibilityHelper.updateLocation(e._accessibilityItem,e)},e.prototype.onChangeCalculateOriginalDimensions=function(e,t){t.realized&&(e.newValue?this._updateSizeAndTransform(t):this._debouncedDimensionsUpdate.method(t,0,0))},e.prototype.onChangeApplyEXIFOrientation=function(e,t){t.realized&&(e.newValue?this._updateSizeAndTransform(t):this._resetEXIFOrientation(t))},e.prototype.onChangeImagePosition=function(e,t){t.realized&&this._updateSizeAndTransform(t)},e.prototype.onChangeImageRotation=function(e,t){t.realized&&this._updateSizeAndTransform(t)},e.prototype.onChangeFlipHorizontal=function(e,t){t.realized&&this._updateSizeAndTransform(t)},e.prototype.onChangeFlipVertical=function(e,t){t.realized&&this._updateSizeAndTransform(t)},e.prototype.onBeforeOnSelect=function(e){e.initialized&&e.realized&&e.properties.AutoDisableOnSelect&&e.viewState.isAutoDisabled(e.properties.AutoDisableOnSelect())},e.prototype.onAfterOnSelect=function(e){e.initialized&&e.realized&&e.viewState.isAutoDisabled(!1)},e.prototype.onChangeImage=function(e,t){var i=this;if(t.initialized){t.imageSrc(""),t.imageUrl(""),this._clearImageStubs(t),t._lastImagePromise&&(Core.PromiseUtils.abortPromise(t._lastImagePromise,t._lastImagePromiseAbortController),t._lastImagePromise=null,t._lastImagePromiseAbortController=null);var o=new AbortController;t._lastImagePromiseAbortController=o;var r=AppMagic.Utility.createMediaReferenceAsync(e.newValue,o).then((function(e){var r;if(t.initialized&&!(null===(r=null==o?void 0:o.signal)||void 0===r?void 0:r.aborted)){var n=e?e.url.toString():"",a=AppMagic.Utility.formatUrlStringForCss(n);t._currentMediaRef&&t._currentMediaRef.dispose(),t._currentMediaRef=e,t.imageSrc(n),t.imageUrl(a),t.realized&&i._updateSizeAndTransform(t)}else e&&e.dispose()}));t._lastImagePromise=r,r.catch((function(e){Core.PromiseUtils.throwIfCanceled(e)}))}},e.prototype.updateDimensions=function(e,t,i){e.properties.OriginalWidth(i),e.properties.OriginalHeight(t),this._updateDisplayedDimensions(e,t,i)},e.prototype._updateDisplayedDimensions=function(e,t,i){var o=e.modelProperties.ImageRotation.getValue(),r=(o===AppMagic.Constants.ImageRotation.Rotate90||o===AppMagic.Constants.ImageRotation.Rotate270)!==(this._needExifDataCheck(e)&&e.modelProperties.EXIFOrientation.getValue()>4),n=r?t:i,a=r?i:t,s=e.modelProperties.Width.getValue(),l=e.modelProperties.Height.getValue();switch(e.modelProperties.ImagePosition.getValue()){case"center":e.properties.DisplayedWidth(n),e.properties.DisplayedHeight(a),e.properties.OffsetX((s-n)/2),e.properties.OffsetY((l-a)/2);break;case"fill":if(l/a<s/n){var p=s*a/n;e.properties.DisplayedWidth(s),e.properties.DisplayedHeight(p),e.properties.OffsetX(0),e.properties.OffsetY((l-p)/2)}else{var u=l*n/a;e.properties.DisplayedWidth(u),e.properties.DisplayedHeight(l),e.properties.OffsetX((s-u)/2),e.properties.OffsetY(0)}break;case"fit":if(l/a>s/n){p=s*a/n;e.properties.DisplayedWidth(s),e.properties.DisplayedHeight(p),e.properties.OffsetX(0),e.properties.OffsetY((l-p)/2)}else{u=l*n/a;e.properties.DisplayedWidth(u),e.properties.DisplayedHeight(l),e.properties.OffsetX((s-u)/2),e.properties.OffsetY(0)}break;case"stretch":e.properties.DisplayedWidth(s),e.properties.DisplayedHeight(l),e.properties.OffsetX(0),e.properties.OffsetY(0);break;case"tile":e.properties.DisplayedWidth(n),e.properties.DisplayedHeight(a),e.properties.OffsetX(0),e.properties.OffsetY(0)}},e.prototype._applyCssTransform=function(e,t){e.realized&&(e.transform(t.toCssString()),e.hasHorizontalRotation(t.hasHorizontalRotation()))},e.prototype._updateSizeAndTransform=function(e){e.innerVisibility(o.Hidden),this._applyCssTransform(e,this._getTransform(e)),this._updateImageStub(e)},e.prototype._getTransform=function(e){var t=r.Identity;e.modelProperties.FlipHorizontal.getValue()&&(t=r.FlipHorizontal.multiply(t)),e.modelProperties.FlipVertical.getValue()&&(t=r.FlipVertical.multiply(t));var i=e.modelProperties.ImageRotation.getValue();return i&&i!==AppMagic.Constants.ImageRotation.None&&(i===AppMagic.Constants.ImageRotation.Rotate90?t=r.Rotate90.multiply(t):i===AppMagic.Constants.ImageRotation.Rotate270?t=r.Rotate270.multiply(t):i===AppMagic.Constants.ImageRotation.Rotate180&&(t=r.Rotate180.multiply(t))),t},e.prototype._updateImageStub=function(e){var t=e.modelProperties.ImageRotation.getValue(),i=t===AppMagic.Constants.ImageRotation.Rotate90||t===AppMagic.Constants.ImageRotation.Rotate270;if(this._needExifDataCheck(e)||e.modelProperties.CalculateOriginalDimensions.getValue()||i){var r=e._currentMediaRef?e._currentMediaRef.url.toString():"";if(e.container){var n=e.container.querySelector(".appmagic-image-stub-container");n&&(e.imageStub=document.createElement("img"),e.imageStub.className="appmagic-image-stub",e.imageStub.alt="",n.appendChild(e.imageStub),e.imageStub.addEventListener("load",e.onImageStubLoadHandler,!1),e.imageStub.src=r)}}else e.innerHeight("100%"),e.innerWidth("100%"),e.properties.ImagePosition&&e.backgroundSize(e.properties.ImagePosition().size),e.innerVisibility(o.Visible)},e.prototype._clearImageStubs=function(e){if(e.container){var t=e.container.querySelector(".appmagic-image-stub");t&&(t.parentNode&&t.parentNode.removeChild(t),t=null),e.imageStub=null}},e.prototype._getEXIFTransform=function(e){var t=r.Identity;if(e&&e>1)switch(e){case 2:t=r.FlipHorizontal;break;case 3:t=r.Rotate180;break;case 4:t=r.Rotate180.multiply(r.FlipHorizontal);break;case 5:t=r.Rotate270.multiply(r.FlipHorizontal);break;case 6:t=r.Rotate90;break;case 7:t=r.Rotate90.multiply(r.FlipHorizontal);break;case 8:t=r.Rotate270}return t},e.prototype._resetEXIFOrientation=function(e){this._updateSizeAndTransform(e)},e.prototype._handleExifData=function(e){try{return EXIF.getTag(e,"Orientation")||0}catch(e){return-1}},e.prototype._getExifData=function(e,t){try{EXIF.getData(e,t)}catch(i){t(e)}},e.prototype._needExifDataCheck=function(e){if(e._currentMediaRef&&e._currentMediaRef.url){var t=e._currentMediaRef.url.toString().split("?")[0];if((/^data\:/i.test(t)&&t.match(/^data\:([^\;]+)\;base64,/im)&&t.match(/^data\:([^\;]+)\;base64,/im).length>0||/^blob\:/i.test(t))&&!/\.svg$/i.test(t)&&!/\.png$/i.test(t)&&!/\.gif$/i.test(t)&&!/\.bmp$/i.test(t)&&!/image\/gif/i.test(t)&&!/image\/bmp/i.test(t)&&!/image\/png/i.test(t)&&Core.FeatureGates.controls.applyEXIFOrientation&&e.modelProperties.ApplyEXIFOrientation&&e.modelProperties.ApplyEXIFOrientation.getValue())return!0}else if(Core.FeatureGates.controls.applyEXIFOrientation&&e.modelProperties.ApplyEXIFOrientation&&e.modelProperties.ApplyEXIFOrientation.getValue())return!0;return!1},e.prototype._onImageStubLoad=function(e){if(e.initialized&&e.realized&&e.imageStub&&ko.isObservable(e.properties.Height)&&ko.isObservable(e.properties.Width)){var t={height:AppMagic.Controls.converters.pxHorizontalConverter.view(e.properties.Height()),width:AppMagic.Controls.converters.pxVerticalConverter.view(e.properties.Width()),backgroundSize:e.properties.ImagePosition().size},i=e.imageStub.width,r=e.imageStub.height;if(e.modelProperties.CalculateOriginalDimensions.getValue()&&e.properties.OriginalWidth&&e.properties.OriginalHeight&&this._debouncedDimensionsUpdate.method(e,r,i),this._needExifDataCheck(e)){var n=this;this._getExifData(e.imageStub,(function(){if(e.initialized&&e.realized){var a=n._handleExifData(this);e.properties.EXIFOrientation(a),e.modelProperties.CalculateOriginalDimensions.getValue()&&n._updateDisplayedDimensions(e,r,i);var s=n._getTransform(e);if(a>-1){var l=n._getEXIFTransform(a);s=s.multiply(l)}n._applyCssTransform(e,s),n._applyCompensatedImageSize(e,n._getCompensatedSize(t,s.hasHorizontalRotation())),e.innerVisibility(o.Visible)}}))}else this._applyCompensatedImageSize(e,this._getCompensatedSize(t,this._getTransform(e).hasHorizontalRotation())),e.innerVisibility(o.Visible),e.properties.EXIFOrientation(1);this._clearImageStubs(e)}},e.prototype._getCompensatedSize=function(e,t){var i={height:"100%",width:"100%",backgroundSize:e.backgroundSize};return t&&(i.height=e.width,i.width=e.height),i},e.prototype._applyCompensatedImageSize=function(e,t){e.realized&&(e.innerHeight(t.height),e.innerWidth(t.width),e.backgroundSize(t.backgroundSize))},e.prototype._onClick=function(e){return e.viewState.displayMode()===AppMagic.Constants.DisplayMode.Edit&&e.behaviors.OnSelect(),!0},e.prototype._onImageLoad=function(e){return e.realized&&e.imageAvailable(!0),!0},e.prototype._onImageError=function(e){return e.realized&&e.imageAvailable(!1),!0},e}()},function(e,t,i){i(3),e.exports=i(2)},function(e,t,i){"use strict";i.r(t);var o=i(0);i.d(t,"IContainerAndBackgroundSize",(function(){return o.IContainerAndBackgroundSize})),i.d(t,"IImageControlContext",(function(){return o.IImageControlContext})),i.d(t,"Image",(function(){return o.Image})),i.d(t,"TransformMatrix",(function(){return o.TransformMatrix}))},function(e,t,i){"use strict";i.r(t);var o=i(0);Core.exportToNamespace(["AppMagic","Controls"],o)}]);
//# sourceMappingURL=D:/a/_work/1/s/obj/Assets/js/Image/Image.js.map