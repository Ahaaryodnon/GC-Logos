/*! For license information please see Player.AppHost.js.LICENSE.txt */
(function(){return this?this:window}())["@pa-client/player-apphost"]=function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t){!function(){e.exports=function(){return this?this:window}()["@pa-client/core"]}()},function(e,t){!function(){e.exports=function(){return this?this:window}()["@pa-client/core-services"]}()},function(e,t){!function(){e.exports=function(){return this?this:window}()["@pa-client/appmagic-runtime-app-host"]}()},function(e,t){!function(){e.exports=function(){return this?this:window}()["@pa-client/core-ui"]}()},function(e,t){!function(){e.exports=function(){return this?this:window}()["@pa-client/appmagic-runtime"]}()},function(e,t,n){e.exports=n(6)},function(e,t,n){"use strict";n.r(t);var r,i,o,s=n(0),a=n(1),c=n(3),p=function(){function e(e,t){this._event=e,this._callback=t}return e.prototype.unsubscribe=function(){this._event.unsubscribe(this._callback)},e}(),u=function(){function e(e){void 0===e&&(e=!1);var t=this;this._allowStopPropagation=e,this.fire=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];for(var r=t._subscribers,i=r.length-1;i>=0;i--){var o=r[i].apply(null,e);if(t._allowStopPropagation&&o)return!0}return!1},this._subscribers=[]}return e.prototype.dispose=function(){this._subscribers=[]},e.prototype.subscribe=function(e){return this._subscribers=this._subscribers.concat(e),new p(this,e)},e.prototype.unsubscribe=function(e){this._subscribers=this._subscribers.filter((function(t){return t!==e}))},e}(),l=function(e){function t(t,n,r,i,o,a,c,p,l,d){var h=e.call(this)||this;return h._appManager=a,h._isAppLoaded=d,h._lastSavedUserConsents=[],h.cacheRefreshed=new u,h._reConsentPromise=null,h._appInfoCore=t,h._preloadConnectionUsagesFromCache=n,h._appHost=o,h._userConsentClient=c,h._appResourcesPromise=p,h._preloadConnectionIds=r,h._authResources=i,h._appType=t.appType,h._consentProvider=l,h._loadDatabaseReferences(),(Object(s.isSharedAppHost)()&&s.webPlayer.enableCDSNativeForCustomPages||!h._isCdsAuthConsentNeeded(h._appInfoCore.authResources,h._appInfoCore.userConsents))&&h._completeAppCdsAuthConsentPromise(),h}return __extends(t,e),Object.defineProperty(t.prototype,"consentProvider",{get:function(){return this._consentProvider},enumerable:!1,configurable:!0}),t.prototype._loadDatabaseReferences=function(){(this._isStandaloneAppHostORCustomPagesDisabledScenario()||this._isUnifiedAppScenario())&&this._appInfoCore.databaseReferences&&this._databaseReferencesManager.value.restoreFromServerDatabaseReferences(this._appInfoCore.databaseReferences)},t.prototype._isStandaloneAppHostORCustomPagesDisabledScenario=function(){return!Object(s.isSharedAppHost)()||!s.webPlayer.enableCDSNativeForCustomPages},t.prototype._isUnifiedAppScenario=function(){return s.appHost.enableRootAppMetadataByLogicalName&&this._appType===a.AppTypesFromRP.UnifiedApp},t.prototype.initializeConnectionsForApp=function(e){var t=this;if(!Object(s.isSharedAppHost)())throw new Error("initializeConnectionsForApp should not be called when not running in SharedAppHost mode.");var n=e.appPreloadData;s.webPlayer.enableSharedEntityReferenceMap&&function(){__awaiter(t,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this._loadAppConnectionsInternalAsync(n.id,n.appName,n.environment,n.connectionReferences,n.appConnectionUsages,n.connectionIds,e.getAppResourcesPromise,!1,!1)];case 1:return[2,t.sent()]}}))}))}(),s.webPlayer.enableCDSNativeForCustomPages&&this._databaseReferencesManager.value.restoreFromServerDatabaseReferences(n.databaseReferences,n.id)},t.prototype.updateConnectionsForConsentService=function(e){this._consentProvider.updateConnections(e)},t.prototype.tryGetAndShowRPMessagesAsync=function(){return __awaiter(this,void 0,Promise,(function(){var e,t,n,r,i;return __generator(this,(function(o){switch(o.label){case 0:return[4,this.powerAppsService.tryGetRPMessagesAsync(this._appInfoCore.appId.split("/").pop(),this._appInfoCore.environment.id.split("/").pop())];case 1:e=o.sent(),t=function(e){return __generator(this,(function(t){switch(t.label){case 0:return e.message?(c.ToastHandler.suspendOnClickToastAllowDuplicates({type:c.ToastType.info,message:e.message,targetClass:"player-toast-area",timeout:e.expirationInMilliseconds}),[4,new Promise((function(t){return setTimeout(t,e.expirationInMilliseconds)}))]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))},n=0,r=e,o.label=2;case 2:return n<r.length?(i=r[n],[5,t(i)]):[3,5];case 3:o.sent(),o.label=4;case 4:return n++,[3,2];case 5:return[2]}}))}))},t.prototype.loadAppConnectionsAsync=function(e,t){return this._loadAppConnectionsInternalAsync(this._appInfoCore.appId,this._appInfoCore.powerAppsName,this._appInfoCore.environment,this._appInfoCore.connectionReferences,this._preloadConnectionUsagesFromCache,this._preloadConnectionIds,this._appResourcesPromise,t,e)},t.prototype._loadAppConnectionsInternalAsync=function(e,t,n,r,i,o,a,c,p){var u,l=this;return void 0===c&&(c=!1),s.Log.trackPromiseScenario(s.ScenarioName.PlayerLifecyclePlayerSDKPlayAppLoadAppHostInitConnections,(function(){return l._loadAppConnectionsCoreAsync(e,t,n,r,i,o,a,c,p)}),{AreAppConnectionsLoaded:this._areAppConnectionsLoaded,isAppLoaded:null===(u=this._isAppLoaded)||void 0===u?void 0:u.call(this),operationName:"PlayerLifecycle.PlayerSDK.PlayApp.LoadConnections"})},t.prototype._loadAppConnectionsCoreAsync=function(e,t,n,r,i,o,a,c,p){var u=this;return void 0===c&&(c=!1),Object(s.HashTableUtility_isEmpty)(r)&&!Object(s.isSharedAppHost)()||"true"===Object(s.getWebPlayerQueryParam)("forceConsentDialog")?(this._areAppConnectionsLoaded=!0,a.then((function(){return u._showConsentDialogAsync(r,c)})).then((function(){return u._updateAppResourcesAfterDisambiguation(e,!1,c)}))):s.Log.trackPromiseScenario(s.ScenarioName.PublishedAppDisambiguation,(function(){return Object(s.wrapWithFinally)(u._loadAppConnectionsAsync(e,t,n,r,c,i,o,a,!1,p),(function(){return __awaiter(u,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return this._areAppConnectionsLoaded=!0,[4,this._appHost.onAppConnectionsLoadedAsync()];case 1:return e.sent(),[2]}}))}))}))}))},t.prototype.getAppAuthResourcesAsync=function(){return __awaiter(this,void 0,Promise,(function(){return __generator(this,(function(e){return[2,this._authResources]}))}))},t.prototype.waitForAuthConsentAsync=function(t){var n=this;if(s.FallbackSwitch.isActivated("AppHost.DisableConsentEnforcement"))return e.prototype.waitForAuthConsentAsync.call(this,t);var r,i=this._checkUserConsent(t);return i?(s.Log.trackActivityEvent("PlayerPublishedClient.waitForAuthConsentAsync",{message:"Already consented for ".concat(t),consentSource:i}),Promise.resolve(!0)):(s.Log.trackActivityEvent("PlayerPublishedClient.waitForAuthConsentAsync",{message:"Waiting for consent for ".concat(t)}),new Promise((function(e){r=n.cacheRefreshed.subscribe((function(r){var i=n._checkUserConsent(t);i?(s.Log.trackActivityEvent("PlayerPowerAppsClient.waitForAuthConsentAsync",{message:"Received consent for ".concat(t),consentSource:i}),e(!0)):s.Log.trackActivityEvent("PlayerPowerAppsClient.waitForAuthConsentAsync",{message:"Cache update did not contain consent for ".concat(t,", continuing to wait")})}))})).then((function(e){return r.unsubscribe(),e})))},t.prototype._checkUserConsent=function(e){return this._appInfoCore.userConsents.some((function(t){return"Auth"===t.type&&t.name===e}))?"appInfo":this._lastSavedUserConsents.some((function(t){return"Auth"===t.type&&t.name===e}))?"lastSavedUserConsents":this._appInfoCore.bypassConsent?"bypassConsent":void 0},t.prototype._saveConnectionsFromConsentServiceAsync=function(e){var t=this,n=e.map((function(e){var n,r={will:e.apiScopeWill,wont:e.apiScopeWont},i={id:e.id,name:e.name,environmentName:e.environmentName,apiId:e.apiId,apiRuntimeUrlString:e.apiRuntimeUrlString,apiScopes:r,isAuthenticated:e.isAuthenticated,connectionParameters:e.connectionParamaters},o=null===(n=t.referenceStore.get(e.localConnectionId))||void 0===n?void 0:n.connectionRef.id;return o||(s.CoreLog.warningEx("PlayerPublishedClient._saveConnectionsFromConsentServiceAsync","Could not find ".concat(e.localConnectionId," in connection store")),o=e.apiId),{connection:i,localConnectionId:e.localConnectionId,datasetOverrides:e.datasetOverrides,apiId:o,actions:e.appActions}}));return this.addDisambiguationResultsAsync(n,this._appInfoCore.powerAppsName)},t.prototype._showConsentDialogAsync=function(e,t){var n;return void 0===t&&(t=!1),__awaiter(this,void 0,Promise,(function(){var r,i,o,c,p,u,l,d,h,f=this;return __generator(this,(function(_){switch(_.label){case 0:return[4,this.getAppAuthResourcesAsync()];case 1:return r=_.sent(),i=this._appInfoCore.deviceCapabilities?this._appInfoCore.deviceCapabilities.split(","):[],o=i.some((function(e){return!(f._appInfoCore.userConsents||[]).some((function(t){return"Device"===t.type&&t.name===e}))})),c=(this._appInfoCore.bypassConsent?[]:r).some((function(e){return!(f._appInfoCore.userConsents||[]).some((function(t){return"Auth"===t.type&&t.name===e.resourceId}))})),p=c?r:[],i=o?i:[],this._appInfoCore.databaseReferences&&Object(s.HashTableUtility_some)(this._appInfoCore.databaseReferences,(function(e){return!Object(s.equalsIgnoreCase)(e.databaseDetails.environmentName,f._appInfoCore.environment.name)}))&&c?(u=null!==(n=a.PowerAppsUtility.tryGetConvergedAppIdentifier())&&void 0!==n?n:this._appInfoCore.appId,[4,this._populateDisplayInfoForCdsAuthResourcesAsync(u,p,this._appInfoCore.environment)]):[3,3];case 2:p=_.sent(),_.label=3;case 3:return Object(s.HashTableUtility_isEmpty)(e)&&0===p.length&&0===i.length?(this._completeAppCdsAuthConsentPromise(),[2]):[4,this._appResourcesPromise];case 4:return l=_.sent(),this._userService.appResourceManager.clearResourcesAndPreloadDataCache(this._appInfoCore.appId),d=s.Log.startScenario(s.ScenarioName.PlayerLifecyclePlayerSDKPlayAppLoadAppConnectionsShowConsentDialog,{operationName:"PlayerLifecycle.PlayerSDK.PlayApp.LoadConnections.ShowConsentDialog"}),[4,this._consentProvider.showConsentDialogAsync(e,t,l,p,i,this._userService,this._appInfoCore,this.powerAppsService,this,Object(s.isSkypeTeams)())];case 5:return h=_.sent(),s.Log.endScenario(d,{scenarioResult:s.ScenarioResult.Success,customScenarioData:{approvedConsent:h.approvedConsent}}),h.appResources&&(this._appResources=h.appResources),h.shouldProcessResult?h.approvedConsent?h.connections?[4,this._saveConnectionsFromConsentServiceAsync(h.connections)]:[3,7]:[3,9]:[2];case 6:_.sent(),_.label=7;case 7:return[4,this._handleClickButtonAsync(!0,p,i,e,t)];case 8:return _.sent(),[3,11];case 9:return[4,this._handleClickButtonAsync(!1,p,i,e,t)];case 10:throw _.sent(),Object(s.createCanceledError)();case 11:return[2]}}))}))},t.prototype._handleClickButtonAsync=function(e,t,n,r,i){var o;return __awaiter(this,void 0,Promise,(function(){var r,c,p,u;return __generator(this,(function(l){switch(l.label){case 0:r=[],e&&(this._completeAppCdsAuthConsentPromise(),c=n.map((function(e){return{type:"Device",name:e}})),p=t.map((function(e){return{type:"Auth",name:e.resourceId}})),r=p.concat(c)),l.label=1;case 1:return l.trys.push([1,3,,4]),this._lastSavedUserConsents=r,[4,this._userConsentClient.saveUserConsentsAsync(null!==(o=a.PowerAppsUtility.tryGetConvergedAppIdentifier())&&void 0!==o?o:this._appInfoCore.appId,r)];case 2:return l.sent(),[3,4];case 3:return u=l.sent(),s.CoreLog.errorEx("PlayerPublishedClient._handleClickButtonAsync",{error:u}),[3,4];case 4:return s.Log.trackUIActivityEvent("PlayerPublishedClient._handleConsentResponseAsync",{approvedConsent:e}),this._consentDismissedByUser=!e,e||i||this._appManager.notifyAppExitRequested(),[2]}}))}))},t.prototype.dispose=function(){this._consentProvider.dispose(),e.prototype.dispose.call(this)},t.prototype.notifyCacheRefresh=function(e){this.cacheRefreshed.fire(e)},t.prototype.notifyAppErrorState=function(e){var t;e===a.HttpStatusCode.NotFound?t="AppNotFound":e==a.HttpStatusCode.Forbidden&&(t="AppForbidden"),t&&(s.CoreLog.error("PlayerPublishedClient.notifyAppErrorState","Exiting app due to error code: ".concat(e," - ").concat(t)),this._appManager.notifyAppErrorState({code:t}))},t.prototype.getAppresourcesAndDisambiguate=function(){return __awaiter(this,void 0,Promise,(function(){return __generator(this,(function(e){switch(e.label){case 0:return this._appResourcesPromise=this._userService.appResourceManager.getAppResourcesAsync(this._appInfoCore.appId,!0,!1,!0,a.AppPackageType.PlayerPackage,null,!1,!0),[4,this.loadAppConnectionsAsync(!1,!0)];case 1:return e.sent(),this.consentDismissedByUser&&(this.consentDismissedByUser=!1),[2]}}))}))},t.prototype.getAppMetadataAsync=function(){var e,t,n;return __awaiter(this,void 0,Promise,(function(){var r;return __generator(this,(function(i){switch(i.label){case 0:return r={appId:this._appInfoCore.appId,appName:this._appInfoCore.name,sessionId:s.Log.sessionId},[4,null===(e=this._userService.tryGetEnvironmentService())||void 0===e?void 0:e.getCurrentEnvironmentAsync()];case 1:return[2,(r.environmentId=null!==(n=null===(t=i.sent())||void 0===t?void 0:t.id)&&void 0!==n?n:"",r.tenantId=this._identityService.identity.tenantId,r.objectId=this._identityService.identity.objectId,r)]}}))}))},t.prototype.tryFixUnauthenticatedConnectionsAsync=function(e){return __awaiter(this,void 0,Promise,(function(){var t,n,r;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,5,,6]),this._reConsentPromise?[3,2]:(this._reConsentPromise=this.getAppresourcesAndDisambiguate(),[4,this._reConsentPromise]);case 1:return i.sent(),this._reConsentPromise=null,[3,4];case 2:return[4,this._reConsentPromise];case 3:i.sent(),i.label=4;case 4:return[3,6];case 5:return i.sent(),s.CoreLog.warningEx("PlayerPublishedClient.fixUnauthenticatedConnectionsAsync","Could not load connections. DataSource: ".concat(e)),this._reConsentPromise=null,[2,null];case 6:return t=this.tryGetEntityConnectionReferenceMap(),n=t?Object(s.tryGetValueIgnoreCase)(t,e):null,(r=n?this.referenceStore.tryGet(n):null)?[2,this._appResources.connections.find((function(e){return Object(s.equalsIgnoreCase)(e.id,r.connectionInstanceId)}))]:(s.CoreLog.warningEx("PlayerPublishedClient.fixUnauthenticatedConnectionsAsync","Could not get connection id after re-authentication attempt"),[2,null])}}))}))},t}(AppMagic.PowerApps.AppHostPowerAppsClient),d=function(){function e(e,t,n){void 0===n&&(n={allowRPDeviceConsent:!1}),this._capabilitiesSerializer=e,this._userService=t,this._options=n}return e.prototype.getUserConsents=function(e){var t=(this._capabilitiesSerializer.getConsentedCapabilitiesAsync(e.appId)||[]).map((function(e){return{type:"Device",name:e}}));return this._options.allowRPDeviceConsent?(e.userConsents||[]).concat(t):(e.userConsents||[]).filter((function(e){return"Auth"===e.type})).concat(t)},e.prototype.saveUserConsentsAsync=function(e,t){var n=[];if("string"==typeof e){var r=t.filter((function(e){return"Device"===e.type}));n.push(this._capabilitiesSerializer.setConsentedCapabilitiesAsync(e,r.map((function(e){return e.name}))).catch((function(e){Object(s.throwIfCanceled)(e),s.CoreLog.error("UserConsentClient.saveUserConsentsAsync",e,"Error in saving user consents using capability serializer.")})))}return this._options.allowRPDeviceConsent||(t=t.filter((function(e){return"Device"!==e.type}))),n.push(this._userService.getConnectionServiceAsync().then((function(n){return n.saveUserConsentsAsync(e,t)})).catch((function(e){Object(s.throwIfCanceled)(e),s.CoreLog.error("UserConsentClient.saveUserConsentsAsync",e,"Error in saving user consents on RP.")}))),Object(s.joinIgnoreResultsAsync)(n).catch((function(e){var t=e.find((function(e){return Core.Utility.isCanceledError(e)}));if(t)return Promise.reject(t)}))},e}(),h=n(2),f=n(4),_=Object(s.createForInterface)("AppMagic.Runtime.AppHost.AutomationClientIntegrationCreator"),y=Object(s.createForInterface)("AppMagic.Runtime.App.Host.ErrorSerializersManagerSingleton"),m=Object(s.createForInterface)("AppMagic.Runtime.App.Host.PABinarySerializerSingleton"),g=Object(s.createForInterface)("AppMagic.Runtime.PlayerRuntime"),A=Object(s.createForInterface)("AppMagic.Runtime.AppHost.TeamsIntegration");!function(e){e.Success="Success",e.Failed="Failed",e.SuccessWithErrors="SuccessWithErrors",e.TerminatedOnAppClose="TerminatedOnAppClose",e.Canceled="Canceled"}(r||(r={})),function(e){e.None="None",e.Http="Http"}(i||(i={})),function(e){e[e.error=0]="error",e[e.warning=1]="warning",e[e.success=2]="success",e[e.info=3]="info"}(o||(o={}));var C=function(e){function t(t,n,r,i,o,s){var a=this;return(a=e.call(this,t,n,r,i,s)||this)._notificationProvider=o,a}return __extends(t,e),t.prototype._showToast=function(e,t){var n=e instanceof a.SendHttpError||e instanceof a.ServiceError?i.Http:i.None;this._notificationProvider.showToastMessage({type:"error",message:{message:t.message,clickHandlers:t.linkClickHandlers},timeout:3e4,errorCategory:n,telemetryData:h.RuntimeErrorHandler._tryGetToastTelemetryData(e),clickHandler:null,preventDuplicates:!0})},t.prototype._handleUnhandledErrorAsync=function(e,t){return __awaiter(this,void 0,Promise,(function(){var n,r,o,c;return __generator(this,(function(p){switch(p.label){case 0:return[4,this._userService.userFeaturesManager.isHidePlayerErrorToastsEnabledAsync()];case 1:return n=p.sent(),s.Log.trackActivityEvent("PlayerRuntimeErrorHandler._handleUnhandledErrorAsync",{message:"Unhandled error.",hidePlayerErrorToasts:n}),r=t instanceof a.SendHttpError||t instanceof a.ServiceError?i.Http:i.None,o=h.RuntimeErrorHandler._tryGetToastTelemetryData(t),c=s.FallbackSwitch.isActivated("DOMPurify")?html_sanitize(e):DOMPurify.sanitize(e),this._notificationProvider.showToastMessage({type:"error",message:[e,null,c],timeout:3e4,preventDuplicates:!0,clickHandler:null,errorCategory:r,isSuppressed:n,telemetryData:o}),[2,!0]}}))}))},t.prototype._showRefreshToast=function(){this._notificationProvider.showToastMessage({type:"error",message:[AppMagic.Strings.ConnectionHubDisambiguationRefreshDataSourceFailedMessage,null],timeout:3e4,preventDuplicates:!0,clickHandler:null})},t.prototype._updateAndReturnConnectionsAsync=function(){return __awaiter(this,void 0,Promise,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this._userService.appResourceManager.getAppResourcesAsync(this._appId,!0,!1,!0,a.AppPackageType.PlayerPackage,null,!1,!0)];case 1:return[2,e.sent().connections]}}))}))},t}(h.RuntimeErrorHandler),v=function(e){function t(t,n,r,i,o,s,a,c,p,u,d,h,f,_,y,m,g,A,v){var P=e.call(this)||this;return P._lazyDataStateManager=A,P.isAppLoaded=v,P.internalName="PlayerAppHost["+t.appId+"]",P._appInfo=t,P._appManager=o,P._sendHttpPipeline=s,P._userService=p,P._powerBIProvider=f,P._formsProProvider=_,P._microsoftStreamProvider=y,P._notificationProvider=g,P._powerAppsClient=new l(P._appInfo,n,r,i,P,P._appManager,u,c,m,v),P._powerAppsClient.initialize(a,h,p,d),P._playerRuntimeErrorHandler=new C(P._powerAppsClient,P._userService,P._appInfo.appId,!0,P._notificationProvider,(function(e){return P._refreshDataSourcesAfterRefreshingConnectionsAsync(e)})),P._apiHandler=null,P._appLoaded=!1,P}return __extends(t,e),Object.defineProperty(t.prototype,"appInfo",{get:function(){return this._appInfo},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"automationClient",{get:function(){return this._automationClient},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"powerAppsClient",{get:function(){return this._powerAppsClient},enumerable:!1,configurable:!0}),t.prototype._initializing=function(){var t=this;e.prototype._initializing.call(this),this._state=PlayerApiHost.LocalServices.Platform.LocalHostState.createInitialLocalHostState(),this._appAuthority=new h.AppAuthority(this._userService,this._powerBIProvider,this._formsProProvider,this._microsoftStreamProvider,this._powerAppsClient),this._appHttpPipeline=Object(h.createPreloadingPipeline)(this._sendHttpPipeline,this._appAuthority,!0,(function(){return t._appInfo.powerAppsName||null}),this.appInfo.appId,this.appInfo.appVersion,!1),this._appAuthenticationService=new h.AppAuthenticationService(this._appAuthority,this._userService),this._appHostService=new h.AppHostService(this._powerAppsClient)},t.prototype._registerActionsControllers=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=s.ObjectFactory.instance.getSingleton(y),i=new PlayerApiHost.LocalServices.Platform.Plugins.ActionsControllerPluginHandler(this._apiHandler.communicationChannel,(function(){return e.getAppHostState().serialization}),r,t);this._apiHandler.registerHandler(i.serviceName,i)},t.prototype.getAppHostState=function(){return this._state},t.prototype.initializeView=function(e){var t,n=this;this._apiHandler=e,this._powerAppsClient.registerAppOpenEvents(this.appInfo.appId,this._apiHandler.communicationChannel.appLoadedEvent,this._apiHandler.communicationChannel.appFailedEvent),this._metadataService=new PlayerApiHost.LocalServices.Platform.MetadataService(e.pluginVersionManager),e.pluginVersionManager.versionsExchanged.addListener((function(){n._state=PlayerApiHost.LocalServices.Platform.LocalHostState.updateLocalHostStateAfterPluginMetadataExchanged(n._state,n._metadataService)}));var r=s.ObjectFactory.instance,i=r.getSingleton(m);this._registerActionsControllers(new PlayerApiHost.LocalServices.Plugins.AppIdentityServicePlugin.V2.Controller(this._appAuthenticationService)),this._registerActionsControllers(new PlayerApiHost.LocalServices.Plugins.PowerAppsServicePlugin.V2.Controller(this._appAuthenticationService));var o=this._constructAppPowerAppsClientPluginControllerV2();this._registerActionsControllers(o,new PlayerApiHost.LocalServices.Plugins.AppPowerAppsClientPlugin.V1.Controller(o)),this._registerActionsControllers(new PlayerApiHost.LocalServices.Plugins.SendHttpPipelinePlugin.V1.Controller(this._appHttpPipeline,i));var a=e.communicationChannel;this._apiHandler.registerHandler("AppHttpClientPlugin",new PlayerApiHost.AppHostRuntime.Plugins.AppHttpClientPluginHandler(this._appHttpPipeline,a,(function(e){return e}))),this._apiHandler.registerHandler("UrlLauncherPlugin",new PlayerApiHost.AppHostRuntime.Plugins.UrlLauncherPluginHandler(a,r.getSingleton(f.IUrlLauncherSingletonKey))),this._apiHandler.registerHandler("RuntimeFunctionsPlugin",new PlayerApiHost.AppHostRuntime.Plugins.RuntimeFunctionsPluginHandler(this._handleBehaviorFunctionExitAsync.bind(this),a));var c=new AppMagic.Runtime.App.Host.AppHostErrorHandler({handleAppRuntimeError:function(e,t){return n._playerRuntimeErrorHandler.handleRuntimeErrorAsync(e,t)}},this._userService),p=new PlayerApiHost.AppHostRuntime.Plugins.AppHostPluginHandler(c,a);this._hostCommander=new h.HostCommander(p),p.registerCommander(this._hostCommander),this._apiHandler.registerHandler("AppHostPlugin",p),this._automationClient=this.trackAnonymous(this._initializeAutomationClient(this._hostCommander));var u=null===(t=s.ObjectFactory.instance.getSingleton(_))||void 0===t?void 0:t.getAutomationClientIntegration(this._automationClient,this._apiHandler.communicationChannel);if(u&&this.trackAnonymous(u),Object(s.isWebPlayer)()){var l=s.ObjectFactory.instance.getSingleton(A);this._apiHandler.registerHandler("TeamsHostClientTypePlugin",new PlayerApiHost.AppHostRuntime.Plugins.TeamsHostClientTypePluginHandler(l.getHostClientType(),a));var d=Object(s.HashTableUtility_create)(),y=new PlayerApiHost.LocalServices.Platform.Plugins.ContextAwareCapability;d[y.capabilityName]=y,this._registerActionsControllers(new PlayerApiHost.LocalServices.Plugins.SaveDataLoadDataPlugin.V1.Controller(this._lazyDataStateManager,i,d))}this._apiHandler.registerHandler("OfficeHeader",new PlayerApiHost.CordovaApiHost.Plugins.OfficeHeaderPlugin(this._apiHandler.communicationChannel)),this._apiHandler.registerHandler("EcsFeaturesPlugin",new PlayerApiHost.AppHostRuntime.Plugins.EcsFeaturesPluginHandler(a))},t.prototype.onAppConnectionsLoadedAsync=function(){return __awaiter(this,void 0,Promise,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this._appHttpPipeline.onConnectionLoadedAsync()];case 1:return e.sent(),[2]}}))}))},t.prototype.onAppLoaded=function(){this._appLoaded||(this._appHttpPipeline.stopPreloadRequestUse(5e3),this._appLoaded=!0)},t.prototype._initializeAutomationClient=function(e){return new h.AppAutomationClient(e)},t.prototype.sendAppExitRequestedEvent=function(){return this._apiHandler?this._apiHandler.communicationChannel.sendAppExitEvent():Promise.resolve()},t.prototype._unloading=function(){e.prototype._unloading.call(this)},t.prototype._disposing=function(){e.prototype._disposing.call(this),this._powerAppsClient.dispose(),this._apiHandler=null},t.prototype._handleBehaviorFunctionExitAsync=function(e){return this._notificationProvider?this._notificationProvider.confirmExit()?this._executeExitFunction(e):this._cancelExit():this._executeExitFunction(e)},t.prototype._executeExitFunction=function(e){var t=this;return this._appManager.exitCurrentAppAsync(e).then((function(){return e?t._userService.logOutAsync():Promise.resolve(!0)}))},t.prototype._cancelExit=function(){return Promise.resolve(!1)},t.prototype._refreshDataSourcesAfterRefreshingConnectionsAsync=function(e){return __awaiter(this,void 0,Promise,(function(){var t,n;return __generator(this,(function(r){switch(r.label){case 0:if(0===e.length)return s.Log.trackActivityEvent("PlayerAppHost._refreshDataSourcesAfterRefreshingConnections",{message:"No datasources to refresh."}),[2,!0];s.Log.trackActivityEvent("PlayerAppHost._refreshDataSourcesAfterRefreshingConnections",{message:"Refreshing data sources for user after successfully authenticating connections."}),r.label=1;case 1:return r.trys.push([1,3,,4]),t=JSON.stringify(e),[4,this._hostCommander.getHostToAppCommand("refreshDataSourcesAfterRefreshingConnections").executeAsync({dsNamesJson:t})];case 2:return[2,r.sent()];case 3:return n=r.sent(),Object(s.throwIfCanceled)(n),s.CoreLog.error("PlayerAppHost._refreshDataSourcesAfterRefreshingConnections",n),[2,!1];case 4:return[2]}}))}))},t.prototype._constructAppPowerAppsClientPluginControllerV2=function(){var e=Object(s.HashTableUtility_create)(),t=new PlayerApiHost.LocalServices.Platform.Plugins.ContextAwareCapability;return e[t.capabilityName]=t,new PlayerApiHost.LocalServices.Plugins.AppPowerAppsClientPlugin.V2.Controller(this._appHostService,e)},t}(s.LifeCycleComponent),P=function(e){function t(t){var n=e.call(this)||this;return n.internalName="PlayerRuntime",n._clientRuntime=t,n._userConsentClient=new s.Lazy((function(){return new d(n._clientRuntime.deviceCapabilityConsentSerializer,n._clientRuntime.userService,{allowRPDeviceConsent:Core.Environment.isWebPlayer()})})),n}return __extends(t,e),Object.defineProperty(t.prototype,"userConsentClient",{get:function(){return this._userConsentClient.value},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clientRuntime",{get:function(){return this._clientRuntime},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"httpClient",{get:function(){return this._clientRuntime.httpClient},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"httpPipeline",{get:function(){return this._clientRuntime.httpPipeline},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"identityService",{get:function(){return this._clientRuntime.identityService},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"powerAppsService",{get:function(){return this._clientRuntime.powerAppsService},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"userService",{get:function(){return this._clientRuntime.userService},enumerable:!1,configurable:!0}),t.prototype._loadingAsync=function(){var t=this;return e.prototype._loadingAsync.call(this).then((function(){return t._clientRuntime.loaded.waitAsync()}))},t.prototype.createAppHost=function(e,t,n,r,i,o,a,c,p){var u=e.environment;(null==u?void 0:u.id)&&(s.CoreLog.verbose("Switching to environment: ".concat(u.id,", for app: ").concat(e.appId)),this.userService.getEnvironmentService().switchEnvironment(u));var l=this._clientRuntime.authenticationRuntime.azureAuthenticationManager.powerBIServiceProvider,d=this._clientRuntime.authenticationRuntime.azureAuthenticationManager.formsProServiceProvider,h=this._clientRuntime.authenticationRuntime.azureAuthenticationManager.microsoftStreamServiceProvider;return new v(e,t,n,r,i,this.httpPipeline,this.identityService,o,this.userService,this.userConsentClient,this._clientRuntime.dataLossPreventionClient,this.powerAppsService,l,d,h,a,c,p,(function(){return i.isAppLoaded}))},t}(Core.LifeCycleComponent);function b(e){var t=s.ObjectFactory.instance.getSingleton(g),n=new S(e,t);return n.initialize(),n.loadAsync(),n}var S=function(e){function t(t,n){var r=e.call(this)||this;return r._config=t,r._playerRuntime=n,r._initializeRuntimeCompletablePromise=Object(s.createCompletablePromise)(),r._loadStringsCompletablePromise=Object(s.createCompletablePromise)(),r}return __extends(t,e),Object.defineProperty(t.prototype,"apiHandler",{get:function(){s.Log.trackErrorEvent("AppHost.apiHandler",{message:"apiHandler not available"})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"playerRuntime",{get:function(){return this._playerRuntime},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"telemetryProvider",{get:function(){return s.Log.providerInstance},enumerable:!1,configurable:!0}),t.prototype._initializing=function(){e.prototype._initializing.call(this),s.Log.setPlayerAppId(this._config.appId),this._config.tenantId&&Core.Environment.setAadTenantId(this._config.tenantId),this._config.serviceProxyUrl&&Core.Environment.setServiceProxyUrl(this._config.serviceProxyUrl),this._start()},t.prototype.appResourceManagerEvents=function(){return this._playerRuntime.userService.appResourceManager.appResourceManagerEvents},t.prototype.getAppPreloadDataAsync=function(e,t){return void 0===t&&(t=!1),__awaiter(this,void 0,Promise,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return n=this._playerRuntime.userService.appResourceManager,e instanceof a.UnifiedAppIdentifier?[4,n.getUnifiedAppPreloadDataAsync(e.environmentId,e.appLogicalName,null,t)]:[3,2];case 1:return[2,r.sent()];case 2:return[4,n.getAppPreloadDataAsync(e,t,!1,!0,a.AppPackageType.WebPlayer)];case 3:return[2,r.sent()]}}))}))},t.prototype._loadingAsync=function(){return __awaiter(this,void 0,Promise,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,e.prototype._loadingAsync.call(this)];case 1:return t.sent(),[4,Object(s.PromiseUtility_join)([this._initializeRuntimeCompletablePromise.promise,this._loadStringsCompletablePromise.promise])];case 2:return t.sent(),[2]}}))}))},t.prototype._start=function(){return __awaiter(this,void 0,Promise,(function(){var e,t;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),(e=[]).push(this._preloadAuthentication()),e.push(this._loadStrings()),e.push(this._initializePlayerRuntime()),[4,Object(s.PromiseUtility_join)(e)];case 1:return n.sent(),[3,3];case 2:return t=n.sent(),s.Log.trackErrorEvent("AppHost._start.Error",{error:t}),[3,3];case 3:return[2]}}))}))},t.prototype._preloadAuthentication=function(){return __awaiter(this,void 0,Promise,(function(){var e,t;return __generator(this,(function(n){return(e=this._playerRuntime.clientRuntime.authenticationRuntime.azureAuthenticationManager).powerAppsServiceProvider.authenticateSilentAsync(),e.appServiceProvider.authenticateSilentAsync(),(t=this._config.cdsOrgUrl)&&e.getProviderForResourceUrl(t,!0).authenticateSilentAsync(),[2]}))}))},t.prototype._loadStrings=function(){var e,t;return __awaiter(this,void 0,Promise,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:null===(e=window.performance)||void 0===e||e.mark("webPlayerStringsStart"),Core.Globalization.WebPlayerCurrentCulture.instance.initializeCurrentCulture(),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,Player.Strings.loadingPromise()];case 2:return r.sent(),null===(t=window.performance)||void 0===t||t.mark("webPlayerStringsLoadComplete"),this._loadStringsCompletablePromise.complete(),[3,4];case 3:return n=r.sent(),this._loadStringsCompletablePromise.error(n),[3,4];case 4:return[2]}}))}))},t.prototype._initializePlayerRuntime=function(){var e,t;return __awaiter(this,void 0,Promise,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:null===(e=window.performance)||void 0===e||e.mark("webPlayerRuntimeStart"),a.PowerAppsUtility.setRegionalRPBaseUrl(this._config.appRuntimeEndpoint),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._playerRuntime.loaded.waitAsync()];case 2:return r.sent(),null===(t=window.performance)||void 0===t||t.mark("webPlayerRuntimeLoaded"),this._initializeRuntimeCompletablePromise.complete(),[3,4];case 3:return n=r.sent(),this._initializeRuntimeCompletablePromise.error(n),[3,4];case 4:return[2]}}))}))},t}(s.LifeCycleComponent);n.d(t,"IConsentProvider",(function(){})),n.d(t,"IConsentDialogResult",(function(){})),n.d(t,"IConsentResult",(function(){})),n.d(t,"IUserConsentClient",(function(){})),n.d(t,"PlayerPublishedClient",(function(){return l})),n.d(t,"PlayerRuntime",(function(){return P})),n.d(t,"IPlayerAppHost",(function(){})),n.d(t,"IPlayerAppManager",(function(){})),n.d(t,"IPlayerRuntime",(function(){})),n.d(t,"initializeAppHost",(function(){return b})),n.d(t,"AppHostErrorCode",(function(){})),n.d(t,"IAppHost",(function(){})),n.d(t,"IAppHostError",(function(){})),n.d(t,"IAutomationClientIntegrationCreator",(function(){})),n.d(t,"ITeamsIntegration",(function(){})),n.d(t,"AutomationClientIntegrationCreatorSingletonKey",(function(){return _})),n.d(t,"ErrorSerializersManagerSingletonKey",(function(){return y})),n.d(t,"PABinarySerializerSingletonKey",(function(){return m})),n.d(t,"PlayerRuntimeSingletonKey",(function(){return g})),n.d(t,"TeamsIntegrationSingletonKey",(function(){return A}))}]);
//# sourceMappingURL=D:/a/_work/1/s/obj/Assets/js/Player.AppHost/Player.AppHost.js.map